---
layout: post
title: IA-32保护模式（2）
date: 2017-1-23 14:40
category: "ASM"
---

### 前言
继续介绍保护模式相关内容

### 正文
之前讲述了GDT，它是存在于整个系统中且唯一的，除此之外，还有一种表，每个任务单独占有一张，称为**局部描述符表（Local Descriptor Table， LDT）**，本质上GDT和LDT是一样的，不过可以将GDT视为一级表，LDT视为二级表，LDT是嵌套在GDT中的。

![ldt](/images/ASM/ldt.png)

LDTR中存放的是LDT的起始位置，相当于一个段选择子。

在保护模式下，实模式中的段寄存器被用作**段选择子（Selector）**，其中存放的不再是段基地址，而另有意义。

![selector](/images/ASM/selector.jpg)

高13位部分为描述符索引（index），用于说明所需要的段的描述符在描述符表中的位置；TI是表指示器，用于说明是在GDT中（0）选择，还是在LDT中（1）选择；请求特权级（RPL）表示选择子的特权级，任务中的每个段都有一个特定的级别，每当一个程序试图访问某个段时，就将程序的特权级与要访问的特权级进行比较。

设置GDTR的汇编指令为LGDT，它只有一个48位（6个字节）的操作数SRC，低字为段界限，高双字为段基址，将存储器中的伪操作符装入GDTR中。

```
LGDT QWORD PTR SRC

SRC STRUC
LIMIT DW 0
BASE DD 0
SRC ENDS
```

设置LDTR的指令为LLDT，操作数及意义与LGDT相同。

访存时：

```
当TI=0时表示段描述符在GDT中，
1.  先从GDTR寄存器中获得GDT基址。
2.  然后再GDT中以段选择器高13位位置索引值得到段描述符。
3.  段描述符符包含段的基址、限长、优先级等各种属性，这就得到了段的起始地址（基址），再以基址加上偏移地址yyyyyyyy才得到最后的线性地址。

当TI=1时表示段描述符在LDT中，
1.  还是先从GDTR寄存器中获得GDT基址。
2.  从LDTR寄存器中获取LDT所在段的位置索引(LDTR高13位)。
3.  以这个位置索引在GDT中得到LDT段描述符从而得到LDT段基址。
4.  用段选择器高13位位置索引值从LDT段中得到段描述符。
5.  段描述符符包含段的基址、限长、优先级等各种属性，这就得到了段的起始地址（基址），再以基址加上偏移地址yyyyyyyy才得到最后的线性地址。
```

### 结尾
待续。。。